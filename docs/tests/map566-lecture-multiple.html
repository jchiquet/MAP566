<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang=""><head>
  <meta charset="utf-8">
  <meta name="generator" content="quarto-0.2.247">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>MAP566 - Stats in Action - Multiple Testing</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
   var mathElements = document.getElementsByClassName("math");
   var macros = [];
   for (var i = 0; i < mathElements.length; i++) {
    var texText = mathElements[i].firstChild;
    if (mathElements[i].tagName == "SPAN") {
     katex.render(texText.data, mathElements[i], {
      displayMode: mathElements[i].classList.contains('display'),
      throwOnError: false,
      macros: macros,
      fleqn: false
     });
  }}});
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
  <script src="../../site_libs/quarto-nav/headroom.min.js"></script>
  <script src="../../site_libs/clipboard/clipboard.min.js"></script>
  <meta name="quarto:offset" content="../../">
  <script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
  <script src="../../site_libs/quarto-search/fuse.min.js"></script>
  <script src="../../site_libs/quarto-search/quarto-search.js"></script>
  <link href="../../docs/tests/map566-lab-tests.html" rel="next">
  <link href="../../docs/tests/map566-lecture-single.html" rel="prev">
  <script src="../../site_libs/quarto-html/quarto.js"></script>
  <script src="../../site_libs/quarto-html/popper.min.js"></script>
  <script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
  <script src="../../site_libs/quarto-html/anchor.min.js"></script>
  <link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
  <link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
  <script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
  <link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
  <link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
  <script id="quarto-search-options" type="application/json">{
    "location": "navbar",
    "copy-button": false,
    "collapse-after": 2,
    "panel-placement": "end",
    "type": "overlay",
    "limit": 20
  }</script>
  <script src="../../site_libs/kePrint-0.0.1/kePrint.js"></script>
  <link href="../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
</head>
<body class="docked">
<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-light ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../index.html">
    <img src="../../logo_X.jpg" alt="">
    <span class="navbar-title">MAP566 - Stats in Action</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../getting-started.html">Getting Started</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jchiquet/MAP566"><i class="bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-hypothesis-testing" role="button" data-bs-toggle="dropdown" aria-expanded="false">Hypothesis Testing</a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-hypothesis-testing">    
        <li class="dropdown-header">Lectures</li>
        <li>
    <a class="dropdown-item" href="../../docs/tests/map566-lecture-single.html">Statistical Tests</a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../docs/tests/map566-lecture-multiple.html">Multiple Testing</a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Labs</li>
        <li>
    <a class="dropdown-item" href="../../docs/tests/map566-lab-tests.html">Statistical tests: exercices</a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Documents</li>
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-regression-models" role="button" data-bs-toggle="dropdown" aria-expanded="false">Regression models</a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-regression-models">    
        <li class="dropdown-header">Lectures</li>
        <li>
    <a class="dropdown-item" href="../../docs/regression/map566-lecture-regression-background.html">Linear regression: quick recap</a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../docs/regression/map566-lecture-polynomial-regression.html">Polynomial regression models</a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">PC/Labs</li>
        <li>
    <a class="dropdown-item" href="../../docs/regression/map566-lab-polynomial-regression.html">Polynomial regression model: exercices</a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../docs/regression/map566-lab-nonlinear-regression.html">Nonlinear regression: exercices</a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-mixed-models" role="button" data-bs-toggle="dropdown" aria-expanded="false">Mixed models</a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-mixed-models">    
        <li class="dropdown-header">Lectures</li>
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">PC/Labs</li>
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-mixture-models" role="button" data-bs-toggle="dropdown" aria-expanded="false">Mixture models</a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-mixture-models">    
        <li class="dropdown-header">Lectures</li>
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">PC/Labs</li>
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-multivariate-models" role="button" data-bs-toggle="dropdown" aria-expanded="false">Multivariate models</a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-multivariate-models">    
        <li class="dropdown-header">Lectures</li>
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">PC/Labs</li>
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-homework" role="button" data-bs-toggle="dropdown" aria-expanded="false">Homework</a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-homework">    
    </ul>
  </li>
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Multiple Testing</h1>
      <button type="button" class="quarto-btn-toggle btn">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
  <div class="sidebar-menu-container"> 
  <ul class="list-unstyled mt-1">
      <ul class="list-unstyled sidebar-section depth1">
    <li class="">
        <div class="me-auto">
            <a class="sidebar-section-item d-inline-flex text-start w-100 " data-bs-toggle="collapse" data-bs-target="#lectures-collapse" aria-expanded="true">
              <div class="me-auto sidebar-section-item">Lectures</div>
            <div><i class="bi bi-chevron-right ms-2"></i></div>
            </a>
        </div>
      <div class="collapse  show" id="lectures-collapse">
        <ul class="list-unstyled sidebar-item-contents">
          <li class="sidebar-item">
  <a href="../../docs/tests/map566-lecture-single.html" class="">Statistical Tests</a>
</li>
          <li class="sidebar-item">
  <a href="../../docs/tests/map566-lecture-multiple.html" class="active">Multiple Testing</a>
</li>
        </ul>
      </div>
    </li>
  </ul>
      <ul class="list-unstyled sidebar-section depth1">
    <li class="">
        <div class="me-auto">
            <a class="sidebar-section-item d-inline-flex text-start w-100 " data-bs-toggle="collapse" data-bs-target="#labs-collapse" aria-expanded="true">
              <div class="me-auto sidebar-section-item">Labs</div>
            <div><i class="bi bi-chevron-right ms-2"></i></div>
            </a>
        </div>
      <div class="collapse  show" id="labs-collapse">
        <ul class="list-unstyled sidebar-item-contents">
          <li class="sidebar-item">
  <a href="../../docs/tests/map566-lab-tests.html" class="">Statistical tests: exercices</a>
</li>
        </ul>
      </div>
    </li>
  </ul>
      <ul class="list-unstyled sidebar-section depth1">
    <li class="">
        <div class="me-auto">
            <a class="sidebar-section-item d-inline-flex text-start w-100 " data-bs-toggle="collapse" data-bs-target="#documents-collapse" aria-expanded="true">
              <div class="me-auto sidebar-section-item">Documents</div>
            <div><i class="bi bi-chevron-right ms-2"></i></div>
            </a>
        </div>
      <div class="collapse  show" id="documents-collapse">
        <ul class="list-unstyled sidebar-item-contents">
        </ul>
      </div>
    </li>
  </ul>
  </ul>
  </div>
</nav>
<!-- toc -->
    <nav id="TOC" role="doc-toc" class="sidebar sidebar-toc">
<h2 id="toc-title">On this page</h2>
<ul>
<li><a href="#introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
<li><a href="#distribution-of-the-p-values" class="nav-link" data-scroll-target="#distribution-of-the-p-values"> <span class="header-section-number">1</span> Distribution of the p-values</a>
<ul class="collapse">
<li><a href="#introduction-1" class="nav-link" data-scroll-target="#introduction-1"> <span class="header-section-number">1.1</span> Introduction</a></li>
<li><a href="#single-comparison-between-2-groups" class="nav-link" data-scroll-target="#single-comparison-between-2-groups"> <span class="header-section-number">1.2</span> Single comparison between 2 groups</a></li>
</ul></li>
<li><a href="#a-single-comparison-among-many-others" class="nav-link" data-scroll-target="#a-single-comparison-among-many-others"> <span class="header-section-number">2</span> A single comparison… among many others</a>
<ul class="collapse">
<li><a href="#permutation-test" class="nav-link" data-scroll-target="#permutation-test"> <span class="header-section-number">2.1</span> Permutation test</a></li>
</ul></li>
<li><a href="#controlling-the-family-wise-error-rate" class="nav-link" data-scroll-target="#controlling-the-family-wise-error-rate"> <span class="header-section-number">3</span> Controlling the Family Wise Error Rate</a>
<ul class="collapse">
<li><a href="#the-bonferroni-correction" class="nav-link" data-scroll-target="#the-bonferroni-correction"> <span class="header-section-number">3.1</span> The Bonferroni correction</a></li>
</ul></li>
<li><a href="#controlling-the-false-discovery-rate" class="nav-link" data-scroll-target="#controlling-the-false-discovery-rate"> <span class="header-section-number">4</span> Controlling the False Discovery Rate</a>
<ul class="collapse">
<li><a href="#detecting-associations" class="nav-link" data-scroll-target="#detecting-associations"> <span class="header-section-number">4.1</span> Detecting associations</a></li>
<li><a href="#the-benjamini-hochberg-procedure" class="nav-link" data-scroll-target="#the-benjamini-hochberg-procedure"> <span class="header-section-number">4.2</span> The Benjamini-Hochberg procedure</a></li>
</ul></li>
</ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/jchiquet/MAP566/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
<!-- main -->
<main class="content">
<header id="title-block-header">
<h1 class="title d-none d-lg-block display-7">Multiple Testing</h1>
</header>

<section id="introduction" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="introduction">Introduction</h2>
<div class="cell" data-warnings="false" data-hash="map566-lecture-multiple_cache/html/unnamed-chunk-1_37374d896ac5eada63a57cca83b22fdc">
<div class="sourceCode" id="cb1"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When we perform a large number of statistical tests, some will have <span class="math inline">p</span>-values less than 0.05 purely by chance, even if all the null hypotheses are really true.</p>
<p>More precisely, if we do a large number <span class="math inline">m</span> of statistical tests, and for <span class="math inline">m_{0\cdot}</span> of them the null hypothesis is actually true, we would expect about 5% of the <span class="math inline">m_{0\cdot}</span> tests to be significant at the 0.05 level, just due to chance: these significant results are false discoveries (or false positives). On the other hand, if some alternative hypothesis are true, we can miss some of them: these non significant results are false negatives.</p>
<p><span class="math display"> \begin{array}{c|c|c|c}
&amp; \text{Null hypothesis true} &amp; \text{Alternative hypothesis true}  &amp; \\ \hline 
\text{Test non significant} &amp; m_{00} &amp; m_{10} &amp; m_{\cdot 0} \\ \hline
\text{Test significant} &amp; m_{01} &amp; m_{11} &amp; m_{\cdot 1} \\ \hline
 &amp; m_{0 \cdot} &amp; m_{1 \cdot} &amp; m
\end{array} </span></p>
<p>If important conclusions and decisions are based on these false positives, it is then important to control the <em>family-wise error rate</em> (FWER):</p>
<ul>
<li>the family-wise error rate is the probability of making one or more false discoveries, or type I errors when performing multiple hypotheses tests</li>
</ul>
<p><span class="math display"> FWER = \mathbb{P}(m_{01}\geq 1) </span></p>
<p>When true positives are expected, it is possible to miss some of them. We then necessarily need to accept false positives if we want to limit the number of these false negatives. It is important in such situation to control the false discovery rate (FDR)</p>
<ul>
<li>The false discovery rate (FDR) is the expected proportion of false discoveries among the discoveries</li>
</ul>
<p><span class="math display">FDR = \mathbb{E}\left(\frac{m_{01}}{m_{01} + m_{11}}\right) = \mathbb{E}\left(\frac{m_{01}}{m_{\cdot1} }\right)</span> Several procedures exist for controlling either the FWER or the FDR.</p>
</section>
<section id="distribution-of-the-p-values" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="distribution-of-the-p-values"><span class="header-section-number">1</span> Distribution of the p-values</h2>
<section id="introduction-1" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="introduction-1"><span class="header-section-number">1.1</span> Introduction</h3>
<p>The health effects of a Roundup-tolerant genetically modified maize, cultivated with or without Roundup, and Roundup alone, were studied during a 2 years study in rats.</p>
<p>For each sex, one control group had access to plain water and standard diet from the closest isogenic non-transgenic maize control; six groups were fed with 11, 22 and 33% of GM NK603 maize either treated or not with Roundup. The final three groups were fed with the control diet and had access to water supplemented with different concentrations of Roundup.</p>
<p>A sample of 200 rats including 100 males and 100 females was randomized into 20 groups of 10 rats of the same sex. Within each group, rats received the same diet. For each sex, there are therefore nine experimental groups and one control group.</p>
<p>The file <ttt>ratSurvival.csv</ttt> reports the lifespan (in days) for each animal. Here, the experiment stopped after 720 days. Then, the reported survival time is 720 for those animals who were still alive at the end of the experiment.</p>
<p>See the opinion of the <a href="http://www.hautconseildesbiotechnologies.fr/sites/www.hautconseildesbiotechnologies.fr/files/file_fields/2015/06/30/121019etudeseraliniaviscshcb.pdf">Haut Conseil des Biotechnologies</a> for more information about this study.</p>
<p>Here is a summary of the data,</p>
<div class="cell" data-hash="map566-lecture-multiple_cache/html/unnamed-chunk-2_5b228fe4359b0050ff2a74947e6e0e09">
<div class="sourceCode" id="cb2"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>survival <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"../../data/ratSurvival.csv"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate_if</span>(is.character, factor) </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>survival <span class="sc">%&gt;%</span> <span class="fu">head</span>() <span class="sc">%&gt;%</span> <span class="fu">kable</span>() <span class="sc">%&gt;%</span> <span class="fu">kable_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class=" lightable-classic" style="font-family: &quot;Arial Narrow&quot;, &quot;Source Sans Pro&quot;, sans-serif; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> time </th>
   <th style="text-align:left;"> regimen </th>
   <th style="text-align:left;"> gender </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 490 </td>
   <td style="text-align:left;"> control </td>
   <td style="text-align:left;"> male </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 575 </td>
   <td style="text-align:left;"> control </td>
   <td style="text-align:left;"> male </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 590 </td>
   <td style="text-align:left;"> control </td>
   <td style="text-align:left;"> male </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 605 </td>
   <td style="text-align:left;"> control </td>
   <td style="text-align:left;"> male </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 610 </td>
   <td style="text-align:left;"> control </td>
   <td style="text-align:left;"> male </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 635 </td>
   <td style="text-align:left;"> control </td>
   <td style="text-align:left;"> male </td>
  </tr>
</tbody>
</table>

</div>
<div class="sourceCode" id="cb3"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">levels</span>(survival<span class="sc">$</span>regimen)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code> [1] "control"     "NK603-11%"   "NK603-11%+R" "NK603-22%"   "NK603-22%+R"
 [6] "NK603-33%"   "NK603-33%+R" "RoundUp A"   "RoundUp B"   "RoundUp C"  </code></pre>
</div>
</div>
</section>
<section id="single-comparison-between-2-groups" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="single-comparison-between-2-groups"><span class="header-section-number">1.2</span> Single comparison between 2 groups</h3>
<p>One objective of this study is the comparison of the survival between the control group and the experimental groups.</p>
<p>Consider for instance the control group of females</p>
<div class="cell" data-hash="map566-lecture-multiple_cache/html/unnamed-chunk-3_1268a87c81564fa74dd448d0bef1bb39">
<div class="sourceCode" id="cb5"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>time_control <span class="ot">&lt;-</span> survival <span class="sc">%&gt;%</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(regimen <span class="sc">==</span> <span class="st">"control"</span>, gender <span class="sc">==</span> <span class="st">"female"</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(time)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Only 2 rats of this group died before the end of the experiment. On the other hand, 7 females of the group fed with 22% of maize NK693 died during the experiment.</p>
<div class="cell" data-hash="map566-lecture-multiple_cache/html/unnamed-chunk-4_dd0207f8b32d922b269139c750b36f93">
<div class="sourceCode" id="cb6"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>time_test <span class="ot">&lt;-</span> survival <span class="sc">%&gt;%</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(regimen <span class="sc">==</span> <span class="st">"NK603-22%"</span>, gender <span class="sc">==</span> <span class="st">"female"</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(time)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A negative effect of the diet on the survival means that the rats of the experimental group tend to die before those of the control group. Then, we would like to test</p>
<p><span class="math display">\begin{aligned}
&amp; H_0: \ "\text{the NK603 22\% diet has no effect on the survival of female rats }"\\
\text{versus } &amp; H_1: \ "\text{the NK603 22\% diet leads to decreased survival time for female rats}"\\ \end{aligned}</span></p>
<p>In terms of survival functions, that means that, under <span class="math inline">H_1</span>, the probability to be alive at a given time <span class="math inline">t</span> is lower for a rat of the experimental group than for a rat of the control group. We then would like to test</p>
<p><span class="math display">\begin{aligned}
&amp; H_0: \ ``\mathbb{P}(T_{\rm test}&gt;t) = \mathbb{P}(T_{\rm control}&gt;t), \text{ for any } t&gt;0" \\
\text{versus } &amp; H_1: \ ``\mathbb{P}(T_{\rm test}&gt;t) &lt; \mathbb{P}(T_{\rm control}&gt;t), \text{ for any } t&gt;0" \end{aligned}</span></p>
<p>Because of the (right) censoring process, we cannot just compare the mean survival times using a <span class="math inline">t</span>-test. On the other hand, we can use the Wilcoxon-Mann-Whitney test which precisely aims to compare the ranks of the survival times in both groups.</p>
<div class="cell" data-hash="map566-lecture-multiple_cache/html/unnamed-chunk-5_be4a156e128224eec84a0c104f58f563">
<div class="sourceCode" id="cb7"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">wilcox.test</span>(time_test, time_control, <span class="at">alternative=</span><span class="st">"less"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>
    Wilcoxon rank sum test with continuity correction

data:  time_test and time_control
W = 22, p-value = 0.01144
alternative hypothesis: true location shift is less than 0</code></pre>
</div>
</div>
<p>Here, the <span class="math inline">p</span>-value should lead us to reject the null hypothesis and conclude that 22% of the GM maize in the diet has a negative effect on the survival.</p>
</section>
</section>
<section id="a-single-comparison-among-many-others" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="a-single-comparison-among-many-others"><span class="header-section-number">2</span> A single comparison… among many others</h2>
<p>Should we really accept this conclusion as it stands? No, because we don’t know the whole story… Remember that there are 9 experimental groups for each sex. Then, 18 comparisons with the control groups are performed.</p>
<div class="cell" data-hash="map566-lecture-multiple_cache/html/unnamed-chunk-6_7d891624b73e55ad49c54af411c18e6a">
<div class="sourceCode" id="cb9"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>do_all_comparisons <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="fu">levels</span>(data<span class="sc">$</span>gender), </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(g) {</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    control <span class="ot">&lt;-</span> <span class="fu">filter</span>(data, regimen <span class="sc">==</span> <span class="st">"control"</span> <span class="sc">&amp;</span> gender<span class="sc">==</span>g) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(time)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    regimes <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">levels</span>(data<span class="sc">$</span>regimen), <span class="st">"control"</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(regimes, <span class="cf">function</span>(regime) {</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>      test <span class="ot">&lt;-</span> <span class="fu">filter</span>(data, gender <span class="sc">==</span> g <span class="sc">&amp;</span> regimen <span class="sc">==</span> regime) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(time)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>      wt  <span class="ot">&lt;-</span> <span class="fu">wilcox.test</span>(test, control, <span class="at">alternative =</span> <span class="st">"less"</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.frame</span>(</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">gender    =</span> g,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">regime    =</span> regime,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">statistic =</span> <span class="fu">unname</span>(wt<span class="sc">$</span>statistic),</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">p.value   =</span> wt<span class="sc">$</span>p.value</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    }) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(p.value)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>all_comparisons <span class="ot">&lt;-</span> <span class="fu">do_all_comparisons</span>(survival)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>all_comparisons <span class="sc">%&gt;%</span> <span class="fu">kable</span>() <span class="sc">%&gt;%</span> <span class="fu">kable_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class=" lightable-classic" style="font-family: &quot;Arial Narrow&quot;, &quot;Source Sans Pro&quot;, sans-serif; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> gender </th>
   <th style="text-align:left;"> regime </th>
   <th style="text-align:right;"> statistic </th>
   <th style="text-align:right;"> p.value </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> NK603-22% </td>
   <td style="text-align:right;"> 22.0 </td>
   <td style="text-align:right;"> 0.0114378 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> NK603-22%+R </td>
   <td style="text-align:right;"> 25.0 </td>
   <td style="text-align:right;"> 0.0213175 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> RoundUp C </td>
   <td style="text-align:right;"> 26.5 </td>
   <td style="text-align:right;"> 0.0284545 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> NK603-11% </td>
   <td style="text-align:right;"> 33.0 </td>
   <td style="text-align:right;"> 0.0716610 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> RoundUp B </td>
   <td style="text-align:right;"> 34.0 </td>
   <td style="text-align:right;"> 0.0845916 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> RoundUp A </td>
   <td style="text-align:right;"> 34.5 </td>
   <td style="text-align:right;"> 0.0915661 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> NK603-33%+R </td>
   <td style="text-align:right;"> 36.0 </td>
   <td style="text-align:right;"> 0.1155685 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> NK603-33% </td>
   <td style="text-align:right;"> 39.0 </td>
   <td style="text-align:right;"> 0.1758393 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> NK603-11%+R </td>
   <td style="text-align:right;"> 40.0 </td>
   <td style="text-align:right;"> 0.1879777 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> NK603-33% </td>
   <td style="text-align:right;"> 40.5 </td>
   <td style="text-align:right;"> 0.2473324 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> NK603-22%+R </td>
   <td style="text-align:right;"> 42.0 </td>
   <td style="text-align:right;"> 0.2849394 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> NK603-11%+R </td>
   <td style="text-align:right;"> 50.0 </td>
   <td style="text-align:right;"> 0.5150864 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> NK603-33%+R </td>
   <td style="text-align:right;"> 51.0 </td>
   <td style="text-align:right;"> 0.5453261 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> RoundUp C </td>
   <td style="text-align:right;"> 54.5 </td>
   <td style="text-align:right;"> 0.6476424 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> RoundUp B </td>
   <td style="text-align:right;"> 58.5 </td>
   <td style="text-align:right;"> 0.7528312 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> NK603-22% </td>
   <td style="text-align:right;"> 64.0 </td>
   <td style="text-align:right;"> 0.8646590 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> NK603-11% </td>
   <td style="text-align:right;"> 74.5 </td>
   <td style="text-align:right;"> 0.9716048 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> RoundUp A </td>
   <td style="text-align:right;"> 75.5 </td>
   <td style="text-align:right;"> 0.9768878 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>Let us plot the ordered p-values:</p>
<div class="cell" data-hash="map566-lecture-multiple_cache/html/code-fold-true_cf99a1bd00cf26c75d523e05a568ba38">
<div class="sourceCode" id="cb10"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>all_comparisons <span class="sc">%&gt;%</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">18</span>, <span class="at">color =</span> regime, <span class="at">y =</span> p.value, <span class="at">shape =</span> gender), <span class="at">size=</span><span class="dv">4</span>) <span class="sc">+</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_log10</span>() <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"regime"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"p-value"</span>) <span class="sc">+</span> <span class="fu">scale_color_viridis_d</span>() <span class="sc">+</span> <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="map566-lecture-multiple_files/figure-html/code-fold-true-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>If we then decide to only report the largest observed differences, associated to the smallest <span class="math inline">p</span>-values, how can we conclude that these differences are statistically significant?</p>
<section id="permutation-test" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="permutation-test"><span class="header-section-number">2.1</span> Permutation test</h3>
<p>A permutation test (also called a randomization test) is a type of statistical significance test in which the distribution of the test statistic under the null hypothesis is obtained by calculating all possible values of the test statistic under rearrangements of the labels on the observed data points. If the labels are exchangeable under the null hypothesis, then the resulting tests yield exact significance levels. Prediction intervals can also be derived.</p>
<p>In our example, imagine that the null hypothesis is true. We can then randomly exchange the labels (i.e.&nbsp;the regimen) and perform the 18 comparisons between the experimental groups and the control groups.</p>
<div class="cell" data-hash="map566-lecture-multiple_cache/html/unnamed-chunk-8_e784a656f364b2eab7338809b3991652">
<div class="sourceCode" id="cb11"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>permuted_data <span class="ot">&lt;-</span> survival <span class="sc">%&gt;%</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(.<span class="sc">$</span>gender) <span class="sc">%&gt;%</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(mutate, <span class="at">regimen =</span> <span class="fu">sample</span>(regimen)) <span class="sc">%&gt;%</span> </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">do_all_comparisons</span>(permuted_data) <span class="sc">%&gt;%</span> <span class="fu">kable</span>() <span class="sc">%&gt;%</span> <span class="fu">kable_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class=" lightable-classic" style="font-family: &quot;Arial Narrow&quot;, &quot;Source Sans Pro&quot;, sans-serif; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> gender </th>
   <th style="text-align:left;"> regime </th>
   <th style="text-align:right;"> statistic </th>
   <th style="text-align:right;"> p.value </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> NK603-33% </td>
   <td style="text-align:right;"> 24.5 </td>
   <td style="text-align:right;"> 0.0287739 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> NK603-22%+R </td>
   <td style="text-align:right;"> 27.5 </td>
   <td style="text-align:right;"> 0.0443266 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> NK603-33%+R </td>
   <td style="text-align:right;"> 30.5 </td>
   <td style="text-align:right;"> 0.0737675 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> RoundUp B </td>
   <td style="text-align:right;"> 32.0 </td>
   <td style="text-align:right;"> 0.0897674 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> NK603-22% </td>
   <td style="text-align:right;"> 32.5 </td>
   <td style="text-align:right;"> 0.0972588 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> NK603-33%+R </td>
   <td style="text-align:right;"> 37.0 </td>
   <td style="text-align:right;"> 0.1609261 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> NK603-22%+R </td>
   <td style="text-align:right;"> 38.0 </td>
   <td style="text-align:right;"> 0.1887010 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> RoundUp A </td>
   <td style="text-align:right;"> 42.0 </td>
   <td style="text-align:right;"> 0.2761239 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> RoundUp B </td>
   <td style="text-align:right;"> 44.5 </td>
   <td style="text-align:right;"> 0.3458949 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> NK603-11% </td>
   <td style="text-align:right;"> 46.0 </td>
   <td style="text-align:right;"> 0.3941412 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> RoundUp C </td>
   <td style="text-align:right;"> 49.5 </td>
   <td style="text-align:right;"> 0.5000000 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> NK603-11%+R </td>
   <td style="text-align:right;"> 52.0 </td>
   <td style="text-align:right;"> 0.5800451 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> NK603-22% </td>
   <td style="text-align:right;"> 52.0 </td>
   <td style="text-align:right;"> 0.5800451 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> NK603-11%+R </td>
   <td style="text-align:right;"> 53.0 </td>
   <td style="text-align:right;"> 0.6077915 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> RoundUp A </td>
   <td style="text-align:right;"> 53.5 </td>
   <td style="text-align:right;"> 0.6244320 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> NK603-11% </td>
   <td style="text-align:right;"> 53.5 </td>
   <td style="text-align:right;"> 0.6335553 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> RoundUp C </td>
   <td style="text-align:right;"> 54.0 </td>
   <td style="text-align:right;"> 0.6393183 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> NK603-33% </td>
   <td style="text-align:right;"> 54.5 </td>
   <td style="text-align:right;"> 0.6605318 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>The test statistics and the <span class="math inline">p</span>-values now really behave how they are supposed to behave under the null hypothesis. If we now repeat the same experiment using many different permutations, we will be able to estimate the <span class="math inline">m</span> distributions of the <span class="math inline">m</span> test statistics as well as the <span class="math inline">m</span> distributions of the <span class="math inline">m</span> <span class="math inline">p</span>-values under the null hypothesis.</p>
<div class="cell" data-hash="map566-lecture-multiple_cache/html/unnamed-chunk-9_32f3244eea9e6657d81439650ec904c3">
<div class="sourceCode" id="cb12"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>n_replicates <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">mclapply</span>(<span class="dv">1</span><span class="sc">:</span>n_replicates, <span class="cf">function</span>(i) {</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  permuted_data <span class="ot">&lt;-</span> survival <span class="sc">%&gt;%</span> </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">split</span>(.<span class="sc">$</span>gender) <span class="sc">%&gt;%</span> </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(mutate, <span class="at">regimen =</span> <span class="fu">sample</span>(regimen)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>()</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">do_all_comparisons</span>(permuted_data) <span class="sc">%&gt;%</span> </span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(statistic, p.value) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">simu =</span> i)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>}, <span class="at">mc.cores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>()) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can estimate, for instance, prediction intervals of level 90% for the <span class="math inline">m=18</span> ordered <span class="math inline">p</span>-values</p>
<div class="cell" data-hash="map566-lecture-multiple_cache/html/unnamed-chunk-10_e299ac256ad3ee5f39574397cb837520">
<div class="sourceCode" id="cb13"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>quantiles_pvalues <span class="ot">&lt;-</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(res, res<span class="sc">$</span>simu) <span class="sc">%&gt;%</span> </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(pull, p.value) <span class="sc">%&gt;%</span> </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(sort) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">apply</span>(<span class="dv">1</span>, quantile, <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.5</span>, <span class="fl">0.95</span>)) <span class="sc">%&gt;%</span> <span class="fu">t</span>() <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">"low"</span>,<span class="st">"median"</span>,<span class="st">"up"</span>)) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">rank =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and plot them, with the original <span class="math inline">p</span>-values</p>
<div class="cell" data-hash="map566-lecture-multiple_cache/html/unnamed-chunk-11_2e925424ba9a74d38c4af9f42305eb17">
<div class="sourceCode" id="cb14"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>quantiles_pvalues <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">x =</span> rank, <span class="at">ymin =</span> low, <span class="at">ymax =</span> up), <span class="at">width=</span><span class="fl">0.2</span>, <span class="at">size=</span><span class="fl">1.5</span>, <span class="at">colour=</span><span class="st">"grey50"</span>) <span class="sc">+</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_log10</span>() <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">"regimen"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"p-value"</span>) <span class="sc">+</span> <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="cn">NULL</span>)  <span class="sc">+</span>  </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> all_comparisons, <span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">18</span>, <span class="at">color =</span> regime, <span class="at">y =</span> p.value, <span class="at">shape=</span>gender), <span class="at">size=</span><span class="dv">4</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="map566-lecture-multiple_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>Here, all the <span class="math inline">p</span>-values, including the smallest ones, belong to the 90% prediction intervals: all the observed <span class="math inline">p</span>-values behave individually how they are expected to behave under the null hypothesis.</p>
<p>In particular, when 18 comparisons are performed, it’s not unlikely under the null hypothesis to obtain a smallest p-value less than or equal to the observed one (0.011).</p>
<p>The probability of such event can easily be estimated by Monte Carlo simulation. Let <span class="math inline">p_{(1),\ell}</span> be the smallest p-value obtained from the <span class="math inline">\ell</span>-th replicate of the Monte Carlo. Then,</p>
<p><span class="math display">
\mathbb{P}\left(p_{(1)} \leq p_{(1)}^{\mathrm{obs}}\right) \approx \frac{1}{L} \sum_{\ell=1}^{L} \mathbf{1}_{\left\{p_{(1),\ell} \leq p_{(1)}^{\mathrm{obs}}\right\}}
</span></p>
<div class="cell" data-hash="map566-lecture-multiple_cache/html/unnamed-chunk-12_9dfbc482b739bb9ce91d232c96f55fd3">
<div class="sourceCode" id="cb15"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>stat_rank1 <span class="ot">&lt;-</span> <span class="fu">split</span>(res, res<span class="sc">$</span>simu) <span class="sc">%&gt;%</span> <span class="fu">map_dbl</span>(<span class="cf">function</span>(x) <span class="fu">sort</span>(x<span class="sc">$</span>statistic)[<span class="dv">1</span>])</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(stat_rank1 <span class="sc">&lt;</span> all_comparisons<span class="sc">$</span>statistic[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>[1] 0.147</code></pre>
</div>
</div>
</section>
</section>
<section id="controlling-the-family-wise-error-rate" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="controlling-the-family-wise-error-rate"><span class="header-section-number">3</span> Controlling the Family Wise Error Rate</h2>
<section id="the-bonferroni-correction" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="the-bonferroni-correction"><span class="header-section-number">3.1</span> The Bonferroni correction</h3>
<p>Imagine that we perform <span class="math inline">m</span> comparisons and that all the <span class="math inline">m</span> null hypotheses are true, i.e.&nbsp;<span class="math inline">m=m_{0\cdot}</span>.. If we use the same significance level <span class="math inline">\alpha_m</span> for the <span class="math inline">m</span> tests, how should we choose <span class="math inline">\alpha_m</span> in order to control the family-wise error rate (FWER)?</p>
<p><span class="math display"> \begin{aligned}
{\rm FWER} &amp;= \mathbb{P}(m_{01}\geq 1) \\
&amp;= 1 - \mathbb{P}(m_{01}= 0)  \\
&amp;= 1 - (1-\alpha_m)^m
\end{aligned} </span></p>
<p>Then, if we set FWER<span class="math inline">=\alpha</span>, the significance level for each individual test should be <span class="math display">\begin{aligned} 
\alpha_m &amp;=  1 - (1-\alpha)^{\frac{1}{m}} \quad \quad (\text{Sidak correction})\\
&amp; \simeq  \frac{\alpha}{m} \quad \quad (\text{Bonferroni correction})
\end{aligned}</span></p>
<p>Let <span class="math inline">p_k</span> be the <span class="math inline">p</span>-value of the <span class="math inline">k</span>-th test. Using the Bonferroni correction, the <span class="math inline">k</span>-th test is significant if <span class="math display">  p_k \leq \alpha_m \quad  \Longleftrightarrow \quad   m \, p_k \leq \alpha </span> We can then either compare the original <span class="math inline">p</span>-value <span class="math inline">p_k</span> to the corrected significance level <span class="math inline">\alpha/m</span>, or compare the <em>adjusted</em> <span class="math inline">p</span>-value <span class="math inline">p_k^{\rm (bonferroni)} =\min(1, m \, p_k)</span> to the critical value <span class="math inline">\alpha</span>.</p>
<div class="cell" data-hash="map566-lecture-multiple_cache/html/unnamed-chunk-13_3e516a172cca3b31fe3443c637b47d9c">
<div class="sourceCode" id="cb17"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">nrow</span>(all_comparisons)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>all_comparisons<span class="sc">$</span>p.value_bonferonni <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="dv">1</span>, all_comparisons<span class="sc">$</span>p.value <span class="sc">*</span> m)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>all_comparisons <span class="sc">%&gt;%</span> <span class="fu">kable</span>() <span class="sc">%&gt;%</span> <span class="fu">kable_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class=" lightable-classic" style="font-family: &quot;Arial Narrow&quot;, &quot;Source Sans Pro&quot;, sans-serif; margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> gender </th>
   <th style="text-align:left;"> regime </th>
   <th style="text-align:right;"> statistic </th>
   <th style="text-align:right;"> p.value </th>
   <th style="text-align:right;"> p.value_bonferonni </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> NK603-22% </td>
   <td style="text-align:right;"> 22.0 </td>
   <td style="text-align:right;"> 0.0114378 </td>
   <td style="text-align:right;"> 0.2058803 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> NK603-22%+R </td>
   <td style="text-align:right;"> 25.0 </td>
   <td style="text-align:right;"> 0.0213175 </td>
   <td style="text-align:right;"> 0.3837141 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> RoundUp C </td>
   <td style="text-align:right;"> 26.5 </td>
   <td style="text-align:right;"> 0.0284545 </td>
   <td style="text-align:right;"> 0.5121818 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> NK603-11% </td>
   <td style="text-align:right;"> 33.0 </td>
   <td style="text-align:right;"> 0.0716610 </td>
   <td style="text-align:right;"> 1.0000000 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> RoundUp B </td>
   <td style="text-align:right;"> 34.0 </td>
   <td style="text-align:right;"> 0.0845916 </td>
   <td style="text-align:right;"> 1.0000000 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> RoundUp A </td>
   <td style="text-align:right;"> 34.5 </td>
   <td style="text-align:right;"> 0.0915661 </td>
   <td style="text-align:right;"> 1.0000000 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> NK603-33%+R </td>
   <td style="text-align:right;"> 36.0 </td>
   <td style="text-align:right;"> 0.1155685 </td>
   <td style="text-align:right;"> 1.0000000 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> NK603-33% </td>
   <td style="text-align:right;"> 39.0 </td>
   <td style="text-align:right;"> 0.1758393 </td>
   <td style="text-align:right;"> 1.0000000 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> female </td>
   <td style="text-align:left;"> NK603-11%+R </td>
   <td style="text-align:right;"> 40.0 </td>
   <td style="text-align:right;"> 0.1879777 </td>
   <td style="text-align:right;"> 1.0000000 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> NK603-33% </td>
   <td style="text-align:right;"> 40.5 </td>
   <td style="text-align:right;"> 0.2473324 </td>
   <td style="text-align:right;"> 1.0000000 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> NK603-22%+R </td>
   <td style="text-align:right;"> 42.0 </td>
   <td style="text-align:right;"> 0.2849394 </td>
   <td style="text-align:right;"> 1.0000000 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> NK603-11%+R </td>
   <td style="text-align:right;"> 50.0 </td>
   <td style="text-align:right;"> 0.5150864 </td>
   <td style="text-align:right;"> 1.0000000 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> NK603-33%+R </td>
   <td style="text-align:right;"> 51.0 </td>
   <td style="text-align:right;"> 0.5453261 </td>
   <td style="text-align:right;"> 1.0000000 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> RoundUp C </td>
   <td style="text-align:right;"> 54.5 </td>
   <td style="text-align:right;"> 0.6476424 </td>
   <td style="text-align:right;"> 1.0000000 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> RoundUp B </td>
   <td style="text-align:right;"> 58.5 </td>
   <td style="text-align:right;"> 0.7528312 </td>
   <td style="text-align:right;"> 1.0000000 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> NK603-22% </td>
   <td style="text-align:right;"> 64.0 </td>
   <td style="text-align:right;"> 0.8646590 </td>
   <td style="text-align:right;"> 1.0000000 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> NK603-11% </td>
   <td style="text-align:right;"> 74.5 </td>
   <td style="text-align:right;"> 0.9716048 </td>
   <td style="text-align:right;"> 1.0000000 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> male </td>
   <td style="text-align:left;"> RoundUp A </td>
   <td style="text-align:right;"> 75.5 </td>
   <td style="text-align:right;"> 0.9768878 </td>
   <td style="text-align:right;"> 1.0000000 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>Using the Bonferroni correction, none of the 18 comparisons is significant.</p>
<p><strong>Remark:</strong> the function <code>p.adjust</code> proposes several adjustements of the <span class="math inline">p</span>-values for multiple comparisons, including the Bonferroni adjustment:</p>
<div class="cell" data-hash="map566-lecture-multiple_cache/html/unnamed-chunk-14_08640bf73c9a42122a2c1021cd6313f1">
<div class="sourceCode" id="cb18"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">p.adjust</span>(all_comparisons<span class="sc">$</span>p.value, <span class="at">method =</span> <span class="st">"bonferroni"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code> [1] 0.2058803 0.3837141 0.5121818 1.0000000 1.0000000 1.0000000 1.0000000
 [8] 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000
[15] 1.0000000 1.0000000 1.0000000 1.0000000</code></pre>
</div>
</div>
<p>The Bonferroni correction is appropriate when a single false positive in a set of tests would be a problem. It is mainly useful when there are a fairly small number of multiple comparisons and very few of them might be significant. The main drawback of the Bonferroni correction is its lack of power: it may lead to a very high rate of false negatives.</p>
<!-- Assume, for instance that all the female rats of all the experimental groups die before the end of the experiment. Each of the $m=18$ original tests is significant, but the Bonferroni correction would lead to considering none of these tests as significant: -->
<!-- ```{r, message=FALSE, warning=FALSE} -->
<!-- x <- subset(data, regimen=="control" & gender=="female")$time -->
<!-- y <- seq(610,700,length=10) -->
<!-- c(wilcox.test(x,y,"greater")$p.value, wilcox.test(x,y,"greater")$p.value*18) -->
<!-- ```  -->
</section>
</section>
<section id="controlling-the-false-discovery-rate" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="controlling-the-false-discovery-rate"><span class="header-section-number">4</span> Controlling the False Discovery Rate</h2>
<section id="detecting-associations" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="detecting-associations"><span class="header-section-number">4.1</span> Detecting associations</h3>
<p>(Example from <a href="http://www.biostathandbook.com/multiplecomparisons.html">Handbook of Biological Statistics</a>)</p>
<p>Garcia-Arenzana et al.&nbsp;(2014) tested associations of 25 dietary variables with <a href="https://breast-cancer-research.biomedcentral.com/articles/10.1186/bcr2102">mammographic density</a>, an important risk factor for breast cancer, in Spanish women. They found the following results</p>
<div class="cell" data-hash="map566-lecture-multiple_cache/html/unnamed-chunk-15_cc2b54b9528804f0019229f864bd5eed">
<div class="sourceCode" id="cb20"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"../../data/dietary.csv"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate_if</span>(is.character, factor) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see that five of the variables show a significant <span class="math inline">p</span>-value (&lt;0.05). However, because Garc?a-Arenzana et al.&nbsp;(2014) tested 25 dietary variables, we would expect one or two variables to show a significant result purely by chance, even if diet had no real effect on mammographic density.</p>
<p>Applying the Bonferroni correction, we divide <span class="math inline">\alpha=0.05</span> by the number of tests (<span class="math inline">m=25</span>) to get the Bonferroni critical value, so a test would have to have <span class="math inline">p&lt;0.002</span> to be significant. Under that criterion, only the test for total calories is significant.</p>
<p>An alternative approach is to control the false discovery rate, i.e the expected proportion of ``discoveries” (significant results) that are actually false positives. FDR control offers a way to increase power while maintaining some principled bound on error.</p>
<p>Imagine for instance that we compare expression levels for 20,000 genes between liver tumors and normal liver cells. We are going to do additional experiments on any genes that show a significant difference between the normal and tumor cells. Then, because we don’t want to miss genes of interest, we are willing to accept up to 25% of the genes with significant results being false positives. We’ll find out they’re false positives when we do the followup experiments. In this case, we would set the false discovery rate to 25%.</p>
</section>
<section id="the-benjamini-hochberg-procedure" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="the-benjamini-hochberg-procedure"><span class="header-section-number">4.2</span> The Benjamini-Hochberg procedure</h3>
<p>The Benjamini-Hochberg (BH) procedure controls the FDR… and it is simple to use!</p>
<p>Indeed, for a given <span class="math inline">\alpha</span> and a given sequence of <strong>ordered</strong> <span class="math inline">p</span>-values <span class="math inline">P_{(1)}</span>, <span class="math inline">P_{(2)}</span>, , <span class="math inline">P_{(m)}</span>, it consists in computing the <span class="math inline">m</span> <em>adjusted</em> <span class="math inline">p</span>-values defined as</p>
<p><span class="math display"> P_{(i)}^{\rm BH} = \min\left( P_{(i)}\frac{m}{i} \ , \ P_{(i+1)}^{\rm BH} \right)</span></p>
<div class="cell" data-hash="map566-lecture-multiple_cache/html/unnamed-chunk-16_4493fd0a7decf40c601361e01d700f80">
<div class="sourceCode" id="cb21"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>p.bh <span class="ot">&lt;-</span> <span class="fu">p.adjust</span>(data<span class="sc">$</span><span class="st">`</span><span class="at">p-value</span><span class="st">`</span>, <span class="at">method =</span> <span class="st">"BH"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, the discoveries, i.e.&nbsp;the significant tests, are those with an ajusted p-value less than <span class="math inline">\alpha</span>.</p>
<p>It can be shown that this procedure guarantees that for <em>independent tests</em>, and for <em>any alternative hypothesis</em>,</p>
<p><span class="math display">\begin{aligned}
{\rm FDR} &amp;= \mathbb{E}{\frac{m_{01}}{m_{01} + m_{11}}} \\
&amp;\leq \frac{m_{0\cdot}}{m} \alpha \\
&amp;\leq \alpha 
\end{aligned}</span> where <span class="math inline">m_{0\cdot}</span> is the (unknown) total number of true null hypotheses, and where the first inequality is an equality with continuous <span class="math inline">p</span>-value distributions.</p>
<p>In our example, the first five tests would be significant with <span class="math inline">\alpha=0.25</span>, which means that we expect no more than 25% of these 5 tests to be false discoveries.</p>
<p><strong>Remark 1:</strong> The BH procedure is equivalent to consider as significant the non adjusted <span class="math inline">p</span>-values smaller than a threshold <span class="math inline">P_{\rm BH}</span> defined as</p>
<p><span class="math display"> P_{\rm BH} = \max_i \left\{ P_{(i)}: \ \ P_{(i)} \leq \alpha \frac{i}{m}  \right\} </span> In other words, the largest <span class="math inline">p</span>-value that has <span class="math inline">P_{(i)}&lt;(i/m)\alpha</span> is significant, and all of the <span class="math inline">P</span>-values smaller than it are also significant, even the ones that aren’t less than their Benjamini-Hochberg critical value <span class="math inline">\alpha \times i/m</span></p>
<div class="cell" data-hash="map566-lecture-multiple_cache/html/unnamed-chunk-17_375e7473971626423df5d17a79d9763d">
<div class="sourceCode" id="cb22"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="fl">0.25</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>critical.value <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span>m)<span class="sc">/</span>m<span class="sc">*</span>alpha</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code># A tibble: 25 × 4
   dietary           `p-value`  p.bh critical.value
   &lt;fct&gt;                 &lt;dbl&gt; &lt;dbl&gt;          &lt;dbl&gt;
 1 Total calories        0.001 0.025           0.01
 2 Olive oil             0.008 0.1             0.02
 3 Whole milk            0.039 0.21            0.03
 4 White meat            0.041 0.21            0.04
 5 Proteins              0.042 0.21            0.05
 6 Nuts                  0.061 0.254           0.06
 7 Cereals and pasta     0.074 0.264           0.07
 8 White fish            0.205 0.491           0.08
 9 Butter                0.212 0.491           0.09
10 Vegetables            0.216 0.491           0.1 
# … with 15 more rows</code></pre>
</div>
</div>
<div class="cell" data-hash="map566-lecture-multiple_cache/html/unnamed-chunk-18_67ea4d53f4ec0c2ecd63063b1a1731f9">
<div class="sourceCode" id="cb24"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>pl1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(data) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span><span class="dv">1</span><span class="sc">:</span>m,<span class="at">y=</span><span class="st">`</span><span class="at">p-value</span><span class="st">`</span>), <span class="at">colour=</span><span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span><span class="dv">1</span><span class="sc">:</span>m,<span class="at">y=</span>critical.value), <span class="at">colour=</span><span class="st">"red"</span>) <span class="sc">+</span><span class="fu">xlab</span>(<span class="st">"(i)"</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(pl1,pl1 <span class="sc">+</span> <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">8</span>)) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.21</span>)) <span class="sc">+</span> <span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="fl">5.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="map566-lecture-multiple_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>The largest <span class="math inline">p</span>-value with <span class="math inline">P_{(i)}&lt;(i/m)\alpha</span> is <em>proteins</em>, where the individual <span class="math inline">p</span>-value (0.042) is less than the <span class="math inline">(i/m)\alpha</span> value of 0.050. Thus the first five tests would be significant.</p>
<p><strong>Remark 2:</strong> The FDR is not bounded by <span class="math inline">\alpha</span>, but by <span class="math inline">(m_{0\cdot}/m) \alpha</span>. We could increase the global power of the tests and get a FDR equal to the desired level <span class="math inline">\alpha</span>, either by defining the critical values as <span class="math inline">(i/m_{0\cdot})\alpha</span>, or by multiplying the adjusted <span class="math inline">p</span>-values by <span class="math inline">m_{0\cdot}/m</span>.</p>
<p>Unfortunately, <span class="math inline">m_{0\cdot}</span> is unknown… but it can be estimated, as the number of non significant tests for instance.</p>
<div class="cell" data-hash="map566-lecture-multiple_cache/html/unnamed-chunk-19_3a0af12a8ee64fd02b61e774831be433">
<div class="sourceCode" id="cb25"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>m0.est <span class="ot">&lt;-</span> <span class="fu">sum</span>(data<span class="sc">$</span>p.bh<span class="sc">&gt;</span>alpha)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>crit.valc <span class="ot">&lt;-</span> <span class="fu">round</span>(data<span class="sc">$</span>critical.value<span class="sc">*</span>m<span class="sc">/</span>m0.est,<span class="dv">4</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>p.bhc <span class="ot">&lt;-</span> <span class="fu">round</span>(data<span class="sc">$</span>p.bh<span class="sc">*</span>m0.est<span class="sc">/</span>m,<span class="dv">4</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data,<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code># A tibble: 10 × 6
   dietary           `p-value`  p.bh critical.value crit.valc p.bhc
   &lt;fct&gt;                 &lt;dbl&gt; &lt;dbl&gt;          &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;
 1 Total calories        0.001 0.025           0.01    0.0125 0.02 
 2 Olive oil             0.008 0.1             0.02    0.025  0.08 
 3 Whole milk            0.039 0.21            0.03    0.0375 0.168
 4 White meat            0.041 0.21            0.04    0.05   0.168
 5 Proteins              0.042 0.21            0.05    0.0625 0.168
 6 Nuts                  0.061 0.254           0.06    0.075  0.203
 7 Cereals and pasta     0.074 0.264           0.07    0.0875 0.211
 8 White fish            0.205 0.491           0.08    0.1    0.393
 9 Butter                0.212 0.491           0.09    0.112  0.393
10 Vegetables            0.216 0.491           0.1     0.125  0.393</code></pre>
</div>
</div>
<p>We would consider the 7 first <span class="math inline">p</span>-values as significant using this new correction.</p>
<!-- ## A Monte Carlo simulation -->
<!-- Let us perform a Monte Carlo simulation to better understand the impact of these corrections. -->
<!-- Let us assume that we observe $(x_{ij}, 1\leq i \leq n_x, 1 \leq j \leq m)$ and $(y_{ij}, 1\leq i \leq n_y, 1 \leq j \leq m)$ where ,  -->
<!-- $$\begin{aligned} -->
<!-- x_{ij} & \iid {\cal N}(\mu_{x,j} \ , \ \sigma_x^2) \\ -->
<!-- y_{ij} & \iid {\cal N}(\mu_{y,j} \ , \ \sigma_y^2)  -->
<!-- \end{aligned} $$ -->
<!-- For $j=1,2,\ldots, m$, we want to test $H_{0,j}: \mu_{x,j}=\mu_{y,j}$ versus $H_{1,j}: \mu_{x,j} \neq \mu_{y,j}$. -->
<!-- For the simulation, we will use $m=140$, $n_x=n_y=50$, $\sigma_x^2=\sigma_y^2=1$ and $\mu_{x,j}=0$ for $1\leq j \leq m$. -->
<!-- Furthermore, the null hypothesis is true for the first $m_{0,\cdot}=120$ variables, assuming that $\mu_{y,j}=0$ for $1\leq j \leq m_{0,\cdot}$. Then, for $m_{0,\cdot}+1\leq j \leq m$, $\mu_{y,j}$ varies from 0.3 to 0.6, which means that the alternative hypothesis is true for these $m_{1,\cdot}=20$ variables. -->
<!-- ```{r} -->
<!-- nx <- 50 -->
<!-- ny <- 50 -->
<!-- m0 <- 120 -->
<!-- m1 <- 20 -->
<!-- mu.x <- rep(0, m0+m1) -->
<!-- mu.y <- c(rep(0,m0),seq(0.3,0.6,length=m1)) -->
<!-- ``` -->
<!-- For each of the $L=1000$ simulated replicate of the same experiment, we will randomly sample observation $x$ and $y$ from the model and perform a $t$-test for each of the $m=140$ variables. We therefore get $m=140$ $p$-values for each of these $L=1000$ replicates. -->
<!-- ```{r} -->
<!-- L <- 1000 -->
<!-- m <- m0+m1 -->
<!-- set.seed(1234) -->
<!-- pval <- matrix(ncol=L,nrow=m) -->
<!-- for (l in (1:L)) { -->
<!--   x.sim <- matrix(rnorm(nx*m, mu.x), ncol=nx) -->
<!--   y.sim <- matrix(rnorm(ny*m, mu.y), ncol=ny) -->
<!--   dat <- cbind(x.sim, y.sim) -->
<!--   pval[,l] <- apply(dat, 1, function(dat) { -->
<!--     t.test(x = dat[1:nx], y = dat[(nx + 1):(nx + ny)])$p.value}) -->
<!-- } -->
<!-- ``` -->
<!-- Setting the significance level $\alpha$ to 0.2, we can compute for each replicate the numbers of true and false discoveries $m_{11}$ and $m_{01}$, as well as the numbers of true and false nondiscoveries  $m_{00}$ and $m_{10}$. -->
<!-- We can then compute the proportion of wrongly rejected null hypotheses -->
<!-- ```{r} -->
<!-- alpha=0.2 -->
<!-- m01 <- colSums(pval[1:m0,] < alpha) -->
<!-- mean(m01/m0) -->
<!-- ``` -->
<!-- As expected, this proportion is close to $\alpha$ which is precisely the probability to wrongly reject the null hypothesis. -->
<!-- The proportion of correctly rejected null hypotheses is an estimate of the power of the test -->
<!-- ```{r} -->
<!-- m11 <- colSums(pval[(m0+1):m,] < alpha) -->
<!-- mean(m11/m1) -->
<!-- ``` -->
<!-- The False Discovery Rate is estimated as the proportion of false discoveries -->
<!-- ```{r} -->
<!-- mean(m01/(m01+m11)) -->
<!-- ``` -->
<!-- This means that among the significant results, about 60% of them are false discoveries. -->
<!-- Let us now apply the Bonferroni correction, and compute the proportion of wrongly and correctly rejected null hypotheses and the proportion of false discoveries -->
<!-- ```{r} -->
<!-- pval.b <- apply(pval,2, function(pval) {p.adjust(pval,method="bonferroni")}) -->
<!-- m01.b <- colSums(pval.b[1:m0,] < alpha) -->
<!-- m11.b <- colSums(pval.b[(m0+1):m,] < alpha) -->
<!-- c(mean(m01.b/m0), mean(m11.b/m1),mean(m01.b/(m01.b+m11.b),na.rm=TRUE)) -->
<!-- ``` -->
<!-- Very few of the true null hypotheses are rejected, which may be a good point, but the price to pay is a very low power (less that 20%).  -->
<!-- The familywise error rate (FWER) is the probability $\mathbb{P}{m_{01}\geq 1}$ to reject *at least* one of the true null hypothesis. This probability remains quite small when the Bonferroni correction is used. -->
<!-- ```{r} -->
<!-- mean(m01.b>=1) -->
<!-- ``` -->
<!-- The Benjamini-Hochberg correction increases the power and controls the FDR as expected since the proportion of false discoveries remains below the level $\alpha$. -->
<!-- ```{r} -->
<!-- pval.bh <- apply(pval,2, function(pval) {p.adjust(pval,method="BH")}) -->
<!-- m01.bh <- colSums(pval.bh[1:m0,] < alpha) -->
<!-- m11.bh <- colSums(pval.bh[(m0+1):m,] < alpha) -->
<!-- c(mean(m01.bh/m0), mean(m11.bh/m1),mean(m01.bh/(m01.bh+m11.bh),na.rm=TRUE)) -->
<!-- ``` -->
<!-- Lastly, we can slightly improve the BH procedure by multiplying the $p$-values by the ratio $\hat{m}_{0\cdot}/m$ -->
<!-- ```{r} -->
<!-- pval.bhc <- pval.bh -->
<!-- for (l in (1:L)) { -->
<!--   m0e <- sum(pval.bh[,l]>alpha) -->
<!--   pval.bhc[,l] <- pval.bh[,l]*m0e/m -->
<!-- } -->
<!-- m01.bhc <- colSums(pval.bhc[1:m0,] < alpha) -->
<!-- m11.bhc <- colSums(pval.bhc[(m0+1):m,] < alpha) -->
<!-- c(mean(m01.bhc/m0), mean(m11.bhc/m1),mean(m01.bhc/(m01.bhc+m11.bhc),na.rm=TRUE)) -->
<!-- ``` -->
<blockquote class="blockquote">
<p>Benjamini, Y., and Y. Hochberg. 1995. Controlling the false discovery rate: a practical and powerful approach to multiple testing. Journal of the Royal Statistical Society B 57: 289-300.</p>
</blockquote>
<blockquote class="blockquote">
<p>Garcia-Arenzana, N., E.M. Navarrete-Munoz, V. Lope, P. Moreo, S. Laso-Pablos, N. Ascunce, F. Casanova-Gomez, C. Sanchez-Contador, C. Santamariña, N. Aragonès, B.P. Gomez, J. Vioque, and M. Pollan. 2014. Calorie intake, olive oil consumption and mammographic density among Spanish women. International Journal of Cancer 134: 1916-1925.</p>
</blockquote>


</section>
</section>
<script type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    setTimeout(function() {
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</main> <!-- /main -->
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../docs/tests/map566-lecture-single.html">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Statistical Tests</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../docs/tests/map566-lab-tests.html">
        <span class="nav-page-text">Statistical tests: exercices</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Last update: November 2021</div>   
  </div>
</footer>


</body></html>